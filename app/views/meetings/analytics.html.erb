<% if current_user.admin? %>
  <div class="analytics-container">
    <h1 class="p-3" >Analytics</h1>
    <%# tab %>
    <ul class="nav tabs-underlined d-flex justify-content-center" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <span class="nav-link tab-underlined <%= params[:tab] == "conversations-tab" ? '' : 'active' %>" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-tab-pane" role="tab" aria-controls="all-tab-pane" aria-selected="true">All</span>
      </li>
      <li class="nav-item" role="presentation">
        <span class="nav-link tab-underlined" id="thismonth-tab" data-bs-toggle="tab" data-bs-target="#thismonth-tab-pane" role="tab" aria-controls="thismonth-tab-pane" aria-selected="false">This Month</span>
      </li>
      <li class="nav-item" role="presentation">
        <span class="nav-link tab-underlined" id="lastmonth-tab" data-bs-toggle="tab" data-bs-target="#lastmonth-tab-pane" role="tab" aria-controls="lastmonth-tab-pane" aria-selected="false">Last Month</span>
      </li>
      <li class="nav-item" role="presentation">
        <span class="nav-link tab-underlined <%= 'active' if params[:tab] == "conversations-tab" %>" id="conversations-tab" data-bs-toggle="tab" data-bs-target="#conversations-tab-pane" role="tab" aria-controls="conversations-tab-pane" aria-selected="false">Individual</span>
      </li>
    </ul>
    <%# tab %>
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade py-3  <%= params[:tab] == "conversations-tab" ? '' : 'show active' %>" id="all-tab-pane" role="tabpanel" aria-labelledby="all-tab" tabindex="0">
        <div class="d-flex justify-content-between">
          <%# all from here %>
          <h2>Number of users : </h2>
          <h2> <%= @users.count %> </h2>
        </div>
        <div class="d-flex justify-content-between">
          <% total_duration_a = 0 %>
          <% @users.each do |user|
          user.meetings.each do |meeting|
          total_duration_a += meeting.duration.to_i
          end
          end
           %>
          <%# <% @meetings.each { |meeting| total_duration += meeting.duration.to_i} %>
          <h2>Total duration : </h2>
          <h2><%= total_duration_a %> min</h2>
        </div>
        <div class="d-flex justify-content-between">
          <h2>Average duration : </h2>
          <% allcount = 0 %>
          <% @users.each do |user|
          allcount += user.meetings.count
          end
           %>
          <h2><%= total_duration_a / allcount %> min</h2>
        </div>
        <div class="d-flex justify-content-between">
          <h2>Total number of meetings : </h2>
          <h2><%= allcount %></h2>
        </div>
        <div class="d-flex justify-content-between">
          <h2 class="text-left">The top creator : </h2>
          <% user_total = {} %>
          <% @users.map do |user| %>
            <% user_total[user.name] = user.meetings.count %>
          <% end %>
          <% top = user_total.max{ |x, y| x[1] <=> y[1] } %>
          <h2><%= top[0]%>, <%= top[1] %> meetings</h2>
        </div>
        <div class="chart-container">
          <canvas data-controller="chart"
              data-chart-data-value="<%= @chart_data.to_json %>"
              data-chart-options-value="<%= @chart_options.to_json %>">
          </canvas>
        </div>
        <%# all until here  %>
      </div>
      <div class="tab-pane fade py-3" id="thismonth-tab-pane" role="tabpanel" aria-labelledby="thismonth-tab" tabindex="0">
        <%# this month from here %>
        <% thismonth = Date.today %>
        <div class="d-flex justify-content-between">
          <% total_duration = 0 %>
          <% @users.each do |user|
          user.meetings.where(start_date: thismonth.beginning_of_month..thismonth.end_of_month).each { |meeting| total_duration += meeting.duration.to_i}
          end %>
          <%# <% @meetings.where(start_date: thismonth.beginning_of_month..thismonth.end_of_month).each { |meeting| total_duration += meeting.duration.to_i} %>
          <h2>Total duration : </h2>
          <h2><%= total_duration %> min</h2>
        </div>
        <div class="d-flex justify-content-between">
          <h2>Average duration : </h2>
          <% thiscount = 0 %>
          <% @users.each do |user|
          thiscount += user.meetings.where(start_date: thismonth.beginning_of_month..thismonth.end_of_month).count
          end %>
          <h2><%= total_duration / thiscount %> min</h2>
        </div>
        <div class="d-flex justify-content-between">
          <h2>Total number of meetings : </h2>
          <h2><%= thiscount %></h2>
        </div>
        <div class="d-flex justify-content-between">
          <h2 class="text-left">The top creator : </h2>
          <% user_total = {} %>
          <% @users.map do |user| %>
            <% user_total[user.name] = user.meetings.where(start_date: thismonth.beginning_of_month..thismonth.end_of_month).count %>
          <% end %>
          <% top = user_total.max{ |x, y| x[1] <=> y[1] } %>
          <h2><%= top[0]%>, <%= top[1] %> meetings</h2>
        </div>
        <%# calculate wages here %>
        <%# calculate wages here %>
        <%# calculate wages here %>
        <%# calculate wages here %>
        <%# this month until here %>
      </div>
      <div class="tab-pane fade py-3" id="lastmonth-tab-pane" role="tabpanel" aria-labelledby="lastmonth-tab" tabindex="0">
        <%# last month from here %>
        <% thismonth = Date.today %>
        <% lastmonth = Date.new(thismonth.year, thismonth.month - 1, thismonth.day) %>
        <div class="d-flex justify-content-between">
          <% total_duration_l = 0 %>
          <% @users.each do |user|
          user.meetings.where(start_date: lastmonth.beginning_of_month..lastmonth.end_of_month).each { |meeting| total_duration_l += meeting.duration.to_i}
          end %>
          <%# <% @meetings.where(start_date: lastmonth.beginning_of_month..lastmonth.end_of_month).each { |meeting| total_duration += meeting.duration.to_i} %>
          <h2>Total duration : </h2>
          <h2><%= total_duration_l %> min</h2>
        </div>
        <div class="d-flex justify-content-between">
          <h2>Average duration : </h2>
          <% last_count = 0 %>
          <% @users.each do |user|
          last_count += user.meetings.where(start_date: lastmonth.beginning_of_month..lastmonth.end_of_month).count
          end %>
          <h2><%= total_duration / last_count %> min</h2>
        </div>
        <div class="d-flex justify-content-between">
          <h2>Total number of meetings : </h2>
          <h2><%= last_count %></h2>
        </div>
        <div class="d-flex justify-content-between">
          <h2 class="text-left">The top creator : </h2>
          <% user_total = {} %>
          <% @users.map do |user| %>
            <% user_total[user.name] = user.meetings.where(start_date: lastmonth.beginning_of_month..lastmonth.end_of_month).count %>
          <% end %>
          <% top = user_total.max{ |x, y| x[1] <=> y[1] } %>
          <h2><%= top[0]%>, <%= top[1] %> meetings</h2>
        </div>
        <%# last month until here %>
      </div>
      <div class="tab-pane fade py-3 <%= 'show active' if params[:tab] == "conversations-tab" %>" id="conversations-tab-pane" role="tabpanel" aria-labelledby="conversations-tab" tabindex="0">
        <%# individual from here %>
        <div class="analytics-container d-flex justify-content-center">
          <div class="avatar-search-a" data-controller="search-users">
            <i class="fa-solid fa-user-group fa-2xl" style="color: #E24429;"></i>
            <form action="/meetings/analytics" method="get" data-search-users-target="form">
              <input
          type="text"
          name="query"
          data-search-users-target="input"
          data-action="keyup->search-users#search"
                value="<%= params[:query] %>"
                >
              </form>
              <div id="form-container" class="avataravatar">
                <div>
                  <div data-search-users-target="users">
                    <% if @users_filtered.present? && @users_filtered.length.positive? %>
                      <%= render 'avatarsfa', users: @users_filtered %>
                    <% end %>
                  </div>
                </div>
                <div data-search-users-target="usersClicked" class="hidden"></div>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-between">
            <h2>User name :</h2>
            <h2><%= @user.name%></h2>
            <% thismonth = Date.today %>
          </div>
          <div class="d-flex justify-content-between">
            <h2>Wages per month</h2>
            <h2>¥ <%= @user.wage%></h2>
          </div>
          <p></p>
          <h2>Result of this month</h2>
          <p></p>
          <div class="d-flex justify-content-between">
            <h2>Total duration : </h2>
            <% total_duration = 0 %>
            <%# <% @meetings.where(user_id: @user).where(start_date: thismonth.beginning_of_month..thismonth.end_of_month).each { |meeting| total_duration += meeting.duration.to_i} %>
            <% @user.meetings.where(start_date: thismonth.beginning_of_month..thismonth.end_of_month).each { |meeting| total_duration += meeting.duration.to_i} %>
            <h2><%= total_duration %> min</h2>
          </div>
          <div class="d-flex justify-content-between">
            <h2>Average duration : </h2>
            <h2><%= total_duration / @user.meetings.where(start_date: thismonth.beginning_of_month..thismonth.end_of_month).count rescue 0 %> min</h2>
          </div>
          <div class="d-flex justify-content-between">
            <h2>Total number of meetings : </h2>
            <h2><%= @user.meetings.where(start_date: thismonth.beginning_of_month..thismonth.end_of_month).count %></h2>
          </div>
          <div class="d-flex justify-content-between">
            <h2>Percentage of meetings :</h2>
            <% wd = 0 %>
            <% (Date.new(thismonth.year, thismonth.month, 1)..Date.new(thismonth.year, thismonth.month, -1)).each { |date| wd += 1 if !(date.saturday? || date.sunday? ) } %>
            <% wdh = wd * 8 %>
            <% thismonth_total = 0%>
            <% @user.meetings.where(start_date: thismonth.beginning_of_month..thismonth.end_of_month).each { |meeting| thismonth_total += meeting.duration.to_i} %>
            <% mh = thismonth_total / 60 %>
            <h2><%= ((mh / wdh.to_f) * 100).round(2) %> %</h2>
          </div>
          <div class="d-flex justify-content-between">
            <h2>Wages for meetings :</h2>
            <h2>¥ <%= (@user.wage * (mh / wdh.to_f)).round(0) %></h2>
          </div>
          <%# individual until here %>
        </div>
      </div>
    </div>
    <%# tab %>
  <% else %>
    <%# non-admin users page %>
    <div class="analytics-container">
      <h1>Analytics</h1>
      <div class="d-flex justify-content-between">
        <h2>Total number of meetings : </h2>
        <h2><%= current_user.meetings.count %></h2>
      </div>
      <div class="d-flex justify-content-between">
        <h2>Total duration :</h2>
        <% user_total_d = 0 %>
        <% current_user.meetings.each { |meeting| user_total_d += meeting.duration.to_i} %>
        <h2><%= user_total_d %></h2>
      </div>
      <div class="d-flex justify-content-between">
        <h2>Average duration</h2>
        <h2><%= user_total_d / current_user.meetings.count %></h2>
      </div>
    </div>
  <% end %>
